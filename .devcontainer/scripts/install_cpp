#!/usr/bin/env bash
set -euo pipefail

if command -v sudo >/dev/null 2>&1 && [ "$(id -u)" -ne 0 ]; then
    SUDO="sudo"
else
    SUDO=""
fi

AC_INSTALL_DIR="${AC_INSTALL_DIR:-/opt/atcoder/gcc}"
WORKSPACE_DIR="${WORKSPACE_DIR:-/workspaces/atcoder}"
GCC_MAJOR_VERSION="${GCC_MAJOR_VERSION:-14}"

echo "[install_cpp] install_dir=${AC_INSTALL_DIR}, gcc_version=${GCC_MAJOR_VERSION}"

# Create symlink from system GCC to /opt/atcoder/gcc for compatibility
echo "[install_cpp] installing GCC ${GCC_MAJOR_VERSION} from Ubuntu repository"
${SUDO} apt-get update
${SUDO} DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    gcc-${GCC_MAJOR_VERSION} g++-${GCC_MAJOR_VERSION}
${SUDO} rm -rf /var/lib/apt/lists/*

# Create symlink for compatibility
${SUDO} mkdir -p "${AC_INSTALL_DIR}"
${SUDO} mkdir -p "${AC_INSTALL_DIR}/bin"
${SUDO} ln -sf /usr/bin/gcc-${GCC_MAJOR_VERSION} "${AC_INSTALL_DIR}/bin/gcc"
${SUDO} ln -sf /usr/bin/g++-${GCC_MAJOR_VERSION} "${AC_INSTALL_DIR}/bin/g++"
${SUDO} ln -sf /usr/bin/gcc-${GCC_MAJOR_VERSION} "${AC_INSTALL_DIR}/bin/cc"

# Create lib symlinks
${SUDO} mkdir -p "${AC_INSTALL_DIR}/lib64"
${SUDO} mkdir -p "${AC_INSTALL_DIR}/lib"
if [ -d /usr/lib/gcc/x86_64-linux-gnu/${GCC_MAJOR_VERSION} ]; then
    ${SUDO} ln -sf /usr/lib/gcc/x86_64-linux-gnu/${GCC_MAJOR_VERSION} "${AC_INSTALL_DIR}/lib64/${GCC_MAJOR_VERSION}"
    ${SUDO} ln -sf /usr/lib/gcc/x86_64-linux-gnu/${GCC_MAJOR_VERSION} "${AC_INSTALL_DIR}/lib/${GCC_MAJOR_VERSION}"
fi

${SUDO} mkdir -p /etc/atcoder
echo "${AC_INSTALL_DIR}" | ${SUDO} tee /etc/atcoder/install_dir.txt >/dev/null

echo "[install_cpp] completed: $("${AC_INSTALL_DIR}/bin/g++" --version | head -n 1)"

# Create ac-library include directory
ACLIB_SRC="${WORKSPACE_DIR}/ac-library"
if [ -d "${ACLIB_SRC}" ]; then
    echo "[install_cpp] installing ac-library from ${ACLIB_SRC}"
    ${SUDO} mkdir -p "${AC_INSTALL_DIR}/include/atcoder"
    ${SUDO} rm -rf "${AC_INSTALL_DIR}/include/atcoder"
    ${SUDO} mkdir -p "${AC_INSTALL_DIR}/include/atcoder"
    ${SUDO} cp -r "${ACLIB_SRC}"/* "${AC_INSTALL_DIR}/include/atcoder/"
else
    echo "[install_cpp] warning: ac-library not found at ${ACLIB_SRC}" >&2
fi

# Precompile bits/stdc++.h with matching compiler flags
echo "[install_cpp] precompiling bits/stdc++.h"
STDC_HEADER=$(find /usr/include/c++/${GCC_MAJOR_VERSION} -name "stdc++.h" -path "*/bits/stdc++.h" 2>/dev/null | head -n 1)
if [ -n "${STDC_HEADER}" ]; then
    STDC_DIR=$(dirname "${STDC_HEADER}")
    echo "[install_cpp] found stdc++.h at ${STDC_HEADER}"
    cd "${STDC_DIR}"
    ${SUDO} "${AC_INSTALL_DIR}/bin/g++" -std=gnu++23 -O2 -march=native stdc++.h
    if [ -f "${STDC_DIR}/stdc++.h.gch" ]; then
        echo "[install_cpp] successfully created ${STDC_DIR}/stdc++.h.gch"
        ${SUDO} chmod 644 "${STDC_DIR}/stdc++.h.gch"
    else
        echo "[install_cpp] warning: failed to create precompiled header" >&2
    fi
else
    echo "[install_cpp] warning: bits/stdc++.h not found" >&2
fi
